######################
# Author: Valentin Koob
# Description: calculates the conditional accuracy function in terms of a percentage of correct response relative to reaction time speed (see Ulrich et al. 2015)
#######################


#Parameters
# RT            vector containing reaction times of one task
# corr         vector containing wether a given reaction to a task was right (coded as 1) or wrong (coded as 0)
# condiiton     (optional) vector containing wether a given reaction was done in a compatible "comp" or incompatible "incomp" trial
# number_bins   the number of bins used to partition the reaction times. Default is 5



calc_CAF = function(RT, corr, condition = NULL,  number_bins = NULL){
  if (base::is.null(number_bins)) {
    number_bins = 5
  }


  df = base::data.frame(RT = RT,
                  corr = corr)
  if (base::is.null(condition)) {
    df$condition = "null"
  }else{
    df$condition = condition
  }

  `%>%` <- magrittr::`%>%`


  caf = df %>% dplyr::group_by(condition) %>% dplyr::mutate(bin = dplyr::ntile(RT, number_bins)) %>%
    dplyr::group_by(condition, bin) %>%
    dplyr::summarise(PC = sum(corr)/length(corr))

  caf = base::as.data.frame(caf)

  if (base::is.null(condition)) {
    return(caf[,-1])
  } else {
    return(caf)
  }
}


calc_CAF_pdfs = function(xs, err, corr){
  pdf = corr + err
  cdf = spatstat.geom::ewcdf(xs, pdf)
  bin = as.integer(base::cut(xs,
                             stats::quantile(cdf, probs = 0:5/5),
                             include.lowest=TRUE)
  )
  corr = corr[!is.na(bin)] #  NAs in bin occur for the tails, if the distributions end well before max(xs)
  err = err[!is.na(bin)]
  bin = bin[!is.na(bin)]
  accs = lapply(unique(bin), function(oneBin){
    corr = corr[bin == oneBin]
    err = err[bin == oneBin]
    acc = sum(corr) / (sum(corr) + sum(err))
    return(acc)
  })
  predCAF = data.frame(bin = unique(bin), PC = unlist(accs))
  return(predCAF)
}

